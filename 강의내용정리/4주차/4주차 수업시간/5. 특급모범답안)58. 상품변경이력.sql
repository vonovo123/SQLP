/*
��ǰ�����̷�_59 ���̺�
  - (#)��ǰID    VARCHAR2(6)
  - (#)��������  VARCHAR2(8)
  - (#)����      NUMBER
  - �����ڵ�     VARCHAR2(3)
  - ��ǰ����     NUMBER
 
��ǰ�� �����̷� 1,000��
����� �����̷� 10��
��ü���� ó�� �������� SQL �ۼ�

�Ʒ� �䱸���׿� �´� SQL�� �ۼ��ϼ���.
�ʿ� �� �ε��� �籸���� �����ϼ���.


1) Ư�� ��ǰ�� �ش��ϴ� ���� �� ã��
   ��ǰ��ȣ ����   : PROD_ID
   ��� �� : ��ǰID, ��������, ����, �����ڵ�, ����


2) ��ü ��ǰ�� ���� �� ã��
   ��� �� : ��ǰID, ��������, ����, �����ڵ�, ����
   
3) ��ü ��ǰ��, �����ڵ庰 ���� ���
   ��� �� : ��ǰID, �����ڵ�,  �ִ��ǰ����, �ּһ�ǰ����, ��ջ�ǰ����, ������������, �����������(�������������� ��������),
             ��ǰ����(�������������� ������������� ��ǰ����)
   
�� �����̶� �������ڰ� ���� ū�� �� ������ ���� ū���� �ǹ��Ѵ�.
*/

ALTER SESSION SET STATISTICS_LEVEL=ALL;

--1��)
-- �ε��� ���� ��
SELECT *
FROM (SELECT /*+ INDEX_DESC(X PK_��ǰ�����̷�_59) */
             ��ǰID, ��������, ����, �����ڵ�, ��ǰ����
           , ROW_NUMBER() OVER(PARTITION BY ��ǰID ORDER BY �������� DESC, ���� DESC) R_NUM
      FROM ��ǰ�����̷�_59 X
      WHERE ��ǰID = :PROD_ID
     )
WHERE R_NUM = 1
;

SELECT * FROM TABLE(DBMS_XPLAN.DISPLAY_CURSOR(NULL, NULL, 'IOSTATS LAST'));
/*
PLAN_TABLE_OUTPUT
---------------------------------------------------------------------------------------------------------
| Id  | Operation                      | Name         | Starts | E-Rows | A-Rows |   A-Time   | Buffers |
---------------------------------------------------------------------------------------------------------
|   0 | SELECT STATEMENT               |              |      1 |        |      1 |00:00:00.01 |     514 |
|*  1 |  VIEW                          |              |      1 |   1010 |      1 |00:00:00.01 |     514 |
|*  2 |   WINDOW NOSORT                |              |      1 |   1010 |   1010 |00:00:00.01 |     514 |
|   3 |    TABLE ACCESS BY INDEX ROWID | ��ǰ�����̷�_|      1 |   1010 |   1010 |00:00:00.01 |     514 |
|*  4 |     INDEX RANGE SCAN DESCENDING| PK_��ǰ������|      1 |   1010 |   1010 |00:00:00.01 |       9 |
---------------------------------------------------------------------------------------------------------
 
Predicate Information (identified by operation id):
---------------------------------------------------
 
   1 - filter("R_NUM"=1)
   2 - filter(ROW_NUMBER() OVER ( PARTITION BY "��ǰID" ORDER BY INTERNAL_FUNCTION("��������") DESC 
              ,INTERNAL_FUNCTION("����") DESC )<=1)
   4 - access("��ǰID"=:PROD_ID)
 */

 

--2��)
SELECT ��ǰID, ��������, ����, �����ڵ�, ��ǰ����
FROM  (SELECT ��ǰID, ��������, ����, �����ڵ�, ��ǰ����, 
         ROW_NUMBER() OVER(PARTITION BY ��ǰID ORDER BY �������� DESC, ���� DESC) ����
       FROM ��ǰ�����̷�_59 A
       )
WHERE ���� = 1;

/*
PLAN_TABLE_OUTPUT
---------------------------------------------------------------------------------------------------------
| Id  | Operation                | Name      | Starts | E-Rows | A-Rows |   A-Time   | Buffers | Reads  |
---------------------------------------------------------------------------------------------------------
|   0 | SELECT STATEMENT         |           |      1 |        |   1000 |00:00:02.85 |    4487 |   4483 |
|*  1 |  VIEW                    |           |      1 |   1010K|   1000 |00:00:02.85 |    4487 |   4483 |
|*  2 |   WINDOW SORT PUSHED RANK|           |      1 |   1010K|   1010K|00:00:02.70 |    4487 |   4483 |
|   3 |    TABLE ACCESS FULL     | ��ǰ������|      1 |   1010K|   1010K|00:00:00.17 |    4487 |   4483 |
---------------------------------------------------------------------------------------------------------
 
Predicate Information (identified by operation id):
---------------------------------------------------
 
   1 - filter("����"=1)
   2 - filter(ROW_NUMBER() OVER ( PARTITION BY "��ǰID" ORDER BY INTERNAL_FUNCTION("��������") DESC 
              ,INTERNAL_FUNCTION("����") DESC )<=1)
 
*/


--3��) MAX KEEP ��� ���
SELECT ��ǰID, �����ڵ�, 
       MAX(��ǰ����) �ְ���ǰ����, MIN(��ǰ����) �ּһ�ǰ����, ROUND(AVG(��ǰ����)) ��ջ�ǰ����, 
       MAX(��������) ��������,  
       MAX(����)     KEEP (DENSE_RANK LAST ORDER BY ��������) �������� ,
       MAX(��ǰ����) KEEP (DENSE_RANK LAST ORDER BY ��������, ����) ������ǰ����
FROM ��ǰ�����̷�_59
GROUP BY ��ǰID, �����ڵ�
;

--3��) �������Լ�
select ��ǰid, �����ڵ�, �������� ������������, ���� ��������, ��ǰ���� ��������
from (
    select ��ǰid, ��������, ����, �����ڵ�, ��ǰ����
         , max(��ǰ����) over (partition by ��ǰid, �����ڵ� )       �ִ��ǰ����
         , min(��ǰ����) over (partition by ��ǰid, �����ڵ� )       �ּһ�ǰ����
        , round(avg(��ǰ����) over (partition by ��ǰid, �����ڵ� )) ��ջ�ǰ����
         , row_number()  over (partition by ��ǰid, �����ڵ� order by �������� desc, ���� desc) ��������ȸ��
    from ��ǰ�����̷�_59
     )
where ��������ȸ�� = 1
;

/*
--------------------------------------------------------------------------------
| Id  | Operation          | Name      |A-Rows |   A-Time   | Buffers | Reads  |
--------------------------------------------------------------------------------
|   0 | SELECT STATEMENT   |           |  9000 |00:00:02.72 |    4487 |   4480 |
|   1 |  SORT GROUP BY     |           |  9000 |00:00:02.72 |    4487 |   4480 |
|   2 |   TABLE ACCESS FULL| ��ǰ������|  1010K|00:00:00.18 |    4487 |   4480 |
--------------------------------------------------------------------------------
*/
 
 
 
 
 
 
 
 
 
 
 
 
 
 