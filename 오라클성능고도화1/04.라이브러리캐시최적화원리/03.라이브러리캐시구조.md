라이브러리 캐시는 Shared pool 내에 위치하며, SQL 공유 커서 및 데이터베이스 오브젝트에 대한 정보를 관리한다.

그리고 여기에 저장되는 정보의 단위를 라이브러리 캐시 오브젝트라고 한다.

SQL 커서 뿐 아니라 컴파일을 거친 프로시저, 함수, 패키기, 트리거 등 PL/SQL 프로그램을 담는 PL/SQL Area도 라이브러리 캐시에 저장한다.

라이브러리 캐시에는 실행가능 오브젝트 뿐아니라 거기서 참조하는 테이블, 인덱스, 클러스터 같은 데이터베이스 오브젝트 정보들도 동등하게 하나의 오브젝트로서 관리된다.

스키마 오브젝트 정보는 데이터 딕셔너리 캐시에도 캐싱돼 있는 이를 읽어 라이브러리 캐시에 중복저장하는 이유는 오브잭트간의 의존성을 관리하는데 목적이 있다.

오브젝트 각각은 자식을 참조하는 다른 오브젝트 목록을 갖는다.

라이브러리 캐시에 캐싱되는 정보를 또 다른 측면에서 두 가지로 나눠 볼 수 있다.

첫번째는 생성 후 DROP 하기 전까지 데이터베이스에 영구적으로 보관되는 오브젝트 정보이고, 테이블, 인덱스, 클러스터, 뷰, 트리거, 패키지, 사용자정의함수/프로시저 등이 여기 속한다.

이 오브젝트는 생성될 때부터 이름을 갖는 것이 특징이다.

둘째는, 생성시점에 생성돼서 인스턴스가 떠있는 동안에만 존재하는 일시적인 오브젝트이다.

커서와 Anonymous PL/SQL이 대표적이다.

이들은 문장을 구성하는 전체 문자열 그대로가 이름 역할을 한다.

라이브러리 캐시는 데이터 딕셔너리 캐시와 함께 Shared Pool에 할당된 메모리 공간을 사용한다.

Shared pool도 DB 버퍼 캐시처럼 LRU 알고리즘에 의해 관리되며, 재사용빈도가 낮은 SQL을 캐시에 밀어냄으로써 새로운 SQL을 캐싱할 수 있도록 공간을 확보한다.

Shared Pool에서 특정 오브젝트 정보 또는 SQL 커서를 위한 Free Chunk를 할당받으려 할 때 필요한 래치가 shared pool 래치이다.

예전에는 하나의 Shared pool 래치로 전체를 관리했으나 9i 부터 Shared Pool을 여러 개 Sub pool로 나눠 관리할 수있게 되면서 래치를 7개 까지 사용할 수 있다.

동시 사용자가 순간적으로 과도한 하드파싱부하를 일으키면 shared pool 래치에 대한 경합 현상이 나타날 수 있다.

라이브러리 캐시도 DB 버퍼 캐시처럼 해시 구조로 관리된다.

해시 버킷에 오브젝트 핸들이 체인으로 연결돼 있고, 핸들을 통해 오브젝트 힙을 찾아가는 구조이다. DB 버퍼 캐시와 마찬가지로 해시 함수를 통해 리턴된 해시 값으로 해시 버킷을 할당한다.

DB 버퍼 캐시에 체인에 연결된 리스트 구조를 보호하기 위해 래치를 사용하는것 처럼 라이브러리 캐시 체인을 탐색하고 변경하려면 library cache 래치를 획득해야 한다.

이에 대한 경합이 발생할 때 latch:libarary cache 대기 이벤트가 발생한다.

DB 버퍼 캐시에서 버퍼 자체를 보호하려고 버퍼 LOCK을 사용한 것처럼 라이브러리 캐시 오브젝트를 보호하기위해 오라클은 라이브러리 캐시 Lock과 pindmf tkdydgksek.

라이브러리 캐시 오브젝트에 접근할 때는 먼저 핸들에 대한 Lock을 획득해야 한다.

그리고 나서 실제 내용이 담긴 힙에서 정보를 읽거나 변경할 때는 pin을 걸어두어야 한다.

LCO를 읽고, 쓰고, 실행하는 동안 다른 프로세스에 의해 정보가 변경되거나 캐시에서 밀려나는 것을 방지한다.

shared pool 래치와 library cache 래치 경합은 소프트/하드 파싱을 동시에 심하게 일으킬 때 발생하고. libaray cache lock 과 library cache pin 대기이벤트는 주로 SQL 수행 도중

DDL을 날릴 때 발생한다.

트랜잭션이 활발한 주간에 DDL 문을 날려 데이터베이스 오브젝트 정의를 변경하면 라이브러리 캐시에 심한 부하를 유발한다.

라이브러리 캐시 최적화를 위한 데이터베이스 관리에서 중요한 것은 다음과 같다.

- 커서를 공유할 수 있는 형태로 SQL을 작성한다. 특히 바인드 변수를 사용해 같은 형태의 SQL에 대한 반복적인 하드파싱이 일어나지 않도록 한다.
  \- 세션 커서 캐싱 기능을 이용해 라이브러리 캐시에서 SQL 찾는 비용을 줄인다.
  \- 애플리케이션 커서 캐싱을 이용해 Parse Call 발생량을 줄인다.
